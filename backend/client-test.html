<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OrderBook UI Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 720px;
        margin: 24px auto;
        padding: 0 12px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
      }
      .side-btn {
        padding: 8px 12px;
        border: 1px solid #999;
        border-radius: 6px;
        cursor: pointer;
        background: #f7f7f7;
      }
      .side-btn.active {
        border-color: #333;
        background: #e9e9e9;
        font-weight: 700;
      }
      input {
        padding: 8px;
        width: 140px;
      }
      button[type="submit"] {
        padding: 8px 14px;
      }
      #log {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        min-height: 220px;
        background: #fafafa;
        white-space: pre-wrap;
      }
      #rejections {
        border: 1px solid #f3c7c7;
        background: #fff0f0;
        border-radius: 6px;
        padding: 8px 10px;
        margin: 10px 0;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0 14px;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background: #f3f3f3;
      }
    </style>
  </head>
  <body>
    <h1>OrderBook UI Test</h1>

    <form id="place-form">
      <div class="row">
        <strong>Client ID:</strong>
        <code id="client-id"></code>
        <button id="regen-client-id" type="button">Regenerate</button>
      </div>

      <div class="row">
        <label for="client-username"><strong>Username:</strong></label>
        <input id="client-username" name="clientUsername" type="text" placeholder="optional" />
        <span>
          <strong>Last seq:</strong>
          <code id="last-seq">0</code>
        </span>
      </div>

      <div class="row">
        <strong>Side:</strong>
        <button class="side-btn active" id="buy-btn" type="button">Bid</button>
        <button class="side-btn" id="sell-btn" type="button">Ask</button>
        <span id="selected-side">buy</span>
      </div>

      <div class="row">
        <label for="price">Price</label>
        <input id="price" name="price" type="number" min="1" step="1" value="100" required />

        <label for="qty">Qty</label>
        <input id="qty" name="qty" type="number" min="1" step="1" value="5" required />

        <button type="submit">Submit</button>
      </div>
    </form>

    <h3>My Portfolio</h3>
    <table>
      <thead>
        <tr>
          <th>Asset</th>
          <th>Available</th>
          <th>Reserved</th>
        </tr>
      </thead>
      <tbody id="portfolio-body"></tbody>
    </table>

    <h3>My Orders</h3>
    <table>
      <thead>
        <tr>
          <th>Seq</th>
          <th>Client Order ID</th>
          <th>Order ID</th>
          <th>Side</th>
          <th>Price</th>
          <th>Original Qty</th>
          <th>Current Qty</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="orders-body"></tbody>
    </table>

    <div id="rejections" hidden></div>

    <h3>Event Log</h3>
    <pre id="log"></pre>

    <script>
      let selectedSide = "buy";
      let ordersById = new Map();
      let portfolio = null;
      const log = (x) => {
        document.getElementById("log").textContent += x + "\n";
        console.log(x);
      };

      const buyBtn = document.getElementById("buy-btn");
      const sellBtn = document.getElementById("sell-btn");
      const selectedSideLabel = document.getElementById("selected-side");
      const form = document.getElementById("place-form");
      const priceInput = document.getElementById("price");
      const qtyInput = document.getElementById("qty");
      const clientIdEl = document.getElementById("client-id");
      const regenClientIdBtn = document.getElementById("regen-client-id");
      const clientUsernameInput = document.getElementById("client-username");
      const lastSeqEl = document.getElementById("last-seq");
      const portfolioBody = document.getElementById("portfolio-body");
      const ordersBody = document.getElementById("orders-body");
      const rejectionsEl = document.getElementById("rejections");

      const renderPortfolio = () => {
        const p = portfolio;
        const mk = (asset, available, reserved) => `
          <tr>
            <td>${asset}</td>
            <td>${available ?? "-"}</td>
            <td>${reserved ?? "-"}</td>
          </tr>
        `;

        if (!p) {
          portfolioBody.innerHTML = '<tr><td colspan="3">No portfolio snapshot yet</td></tr>';
          return;
        }

        portfolioBody.innerHTML = [
          mk("cash", p.cashAvailable, p.cashReserved),
          mk("asset1", p.asset1Available, p.asset1Reserved),
          mk("asset2", p.asset2Available, p.asset2Reserved),
          mk("asset3", p.asset3Available, p.asset3Reserved),
          mk("asset4", p.asset4Available, p.asset4Reserved),
        ].join("");
      };

      const renderOrders = () => {
        const rows = Array.from(ordersById.values()).sort((a, b) => a.orderId - b.orderId);
        if (rows.length === 0) {
          ordersBody.innerHTML = '<tr><td colspan="8">No orders yet</td></tr>';
          return;
        }

        ordersBody.innerHTML = rows
          .map(
            (o) => `
              <tr>
                <td>${o.seq ?? "-"}</td>
                <td><code>${o.clientOrderId ?? "-"}</code></td>
                <td>${o.orderId}</td>
                <td>${o.side}</td>
                <td>${o.price}</td>
                <td>${o.originalQty}</td>
                <td>${o.currentQty}</td>
                <td>${o.status}</td>
              </tr>
            `
          )
          .join("");
      };

      renderPortfolio();
      renderOrders();

      const makeFakeUuid = () => {
        if (globalThis.crypto && typeof globalThis.crypto.randomUUID === "function") {
          return globalThis.crypto.randomUUID();
        }
        // Simple fallback UUID-ish generator for older browsers.
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
          const r = Math.floor(Math.random() * 16);
          const v = c === "x" ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        });
      };

      const getOrCreateClientId = () => {
        const key = "orderbook-test-client-id";
        let id = localStorage.getItem(key);
        if (!id) {
          id = makeFakeUuid();
          localStorage.setItem(key, id);
        }
        return id;
      };

      const getSeqKey = (id) => `orderbook-test-last-seq:${id}`;
      const getOrCreateLastSeq = (id) => {
        const raw = localStorage.getItem(getSeqKey(id));
        const n = raw ? Number(raw) : 0;
        return Number.isFinite(n) && n >= 0 ? n : 0;
      };
      const setLastSeq = (id, n) => {
        localStorage.setItem(getSeqKey(id), String(n));
        lastSeqEl.textContent = String(n);
      };

      let clientId = getOrCreateClientId();
      clientIdEl.textContent = clientId;
      setLastSeq(clientId, getOrCreateLastSeq(clientId));

      const usernameKey = "orderbook-test-client-username";
      clientUsernameInput.value = localStorage.getItem(usernameKey) ?? "";
      clientUsernameInput.addEventListener("input", () => {
        localStorage.setItem(usernameKey, clientUsernameInput.value);
      });

      regenClientIdBtn.addEventListener("click", () => {
        clientId = makeFakeUuid();
        localStorage.setItem("orderbook-test-client-id", clientId);
        clientIdEl.textContent = clientId;
        ordersById = new Map();
        portfolio = null;
        rejectionsEl.hidden = true;
        rejectionsEl.textContent = "";
        setLastSeq(clientId, 0);
        renderPortfolio();
        renderOrders();
        log("new clientId: " + clientId);
      });

      const setSide = (side) => {
        selectedSide = side;
        buyBtn.classList.toggle("active", side === "buy");
        sellBtn.classList.toggle("active", side === "sell");
        selectedSideLabel.textContent = side;
      };

      buyBtn.addEventListener("click", () => setSide("buy"));
      sellBtn.addEventListener("click", () => setSide("sell"));

      const ws = new WebSocket("ws://localhost:8080");

      ws.onopen = () => {
        log("connected");
      };

      ws.onmessage = (e) => {
        log("server: " + e.data);
        let msg;
        try {
          msg = JSON.parse(e.data);
        } catch {
          return;
        }

        if (msg.type === "order_state_snapshot" && msg.clientId === clientId && Array.isArray(msg.orders)) {
          const next = new Map();
          for (const order of msg.orders) {
            const prev = ordersById.get(order.orderId);
            next.set(order.orderId, { ...(prev ?? {}), ...order });
          }
          ordersById = next;
          renderOrders();
          return;
        }

        if (msg.type === "portfolio_snapshot" && msg.clientId === clientId && msg.portfolio) {
          portfolio = msg.portfolio;
          renderPortfolio();
          return;
        }

        if (msg.type === "place_duplicate_ignored" && msg.clientId === clientId) {
          rejectionsEl.hidden = false;
          rejectionsEl.textContent = `Duplicate ignored (seq=${msg.seq}, clientOrderId=${msg.clientOrderId}, dbOrderId=${msg.dbOrderId})`;
          return;
        }

        if (msg.type === "place_rejected") {
          rejectionsEl.hidden = false;
          rejectionsEl.textContent = `Rejected: ${msg.reason ?? "unknown reason"}`;
        }
      };
      ws.onerror = () => log("error: websocket error");
      ws.onclose = () => log("closed");

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const nextSeq = getOrCreateLastSeq(clientId) + 1;
        const clientOrderId = makeFakeUuid();
        const payload = {
          clientId: clientId,
          type: "place",
          seq: nextSeq,
          clientOrderId,
          side: selectedSide,
          price: Number(priceInput.value),
          qty: Number(qtyInput.value),
        };

        if (ws.readyState !== WebSocket.OPEN) {
          log("socket not open; cannot send");
          return;
        }

        ws.send(JSON.stringify(payload));
        setLastSeq(clientId, nextSeq);
        log("client: " + JSON.stringify(payload));
      });
    </script>
  </body>
</html>
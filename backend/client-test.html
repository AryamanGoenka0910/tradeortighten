<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>OrderBook UI Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 720px;
        margin: 24px auto;
        padding: 0 12px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-bottom: 12px;
      }
      .side-btn {
        padding: 8px 12px;
        border: 1px solid #999;
        border-radius: 6px;
        cursor: pointer;
        background: #f7f7f7;
      }
      .side-btn.active {
        border-color: #333;
        background: #e9e9e9;
        font-weight: 700;
      }
      input {
        padding: 8px;
        width: 140px;
      }
      button[type="submit"] {
        padding: 8px 14px;
      }
      #log {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        min-height: 220px;
        background: #fafafa;
        white-space: pre-wrap;
      }
      #rejections {
        border: 1px solid #f3c7c7;
        background: #fff0f0;
        border-radius: 6px;
        padding: 8px 10px;
        margin: 10px 0;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 10px 0 14px;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background: #f3f3f3;
      }
    </style>
  </head>
  <body>
    <h1>OrderBook UI Test</h1>

    <form id="place-form">
      <div class="row">
        <strong>Client ID:</strong>
        <code id="client-id"></code>
        <button id="regen-client-id" type="button">Regenerate</button>
      </div>

      <div class="row">
        <strong>Side:</strong>
        <button class="side-btn active" id="buy-btn" type="button">Bid</button>
        <button class="side-btn" id="sell-btn" type="button">Ask</button>
        <span id="selected-side">buy</span>
      </div>

      <div class="row">
        <label for="price">Price</label>
        <input id="price" name="price" type="number" min="1" step="1" value="100" required />

        <label for="qty">Qty</label>
        <input id="qty" name="qty" type="number" min="1" step="1" value="5" required />

        <button type="submit">Submit</button>
      </div>
    </form>

    <h3>My Orders</h3>
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Side</th>
          <th>Price</th>
          <th>Original Qty</th>
          <th>Current Qty</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="orders-body"></tbody>
    </table>

    <div id="rejections" hidden></div>

    <h3>Event Log</h3>
    <pre id="log"></pre>

    <script>
      let selectedSide = "buy";
      let ordersById = new Map();
      const log = (x) => {
        document.getElementById("log").textContent += x + "\n";
        console.log(x);
      };

      const buyBtn = document.getElementById("buy-btn");
      const sellBtn = document.getElementById("sell-btn");
      const selectedSideLabel = document.getElementById("selected-side");
      const form = document.getElementById("place-form");
      const priceInput = document.getElementById("price");
      const qtyInput = document.getElementById("qty");
      const clientIdEl = document.getElementById("client-id");
      const regenClientIdBtn = document.getElementById("regen-client-id");
      const ordersBody = document.getElementById("orders-body");
      const rejectionsEl = document.getElementById("rejections");

      const renderOrders = () => {
        const rows = Array.from(ordersById.values()).sort((a, b) => a.orderId - b.orderId);
        if (rows.length === 0) {
          ordersBody.innerHTML = '<tr><td colspan="6">No orders yet</td></tr>';
          return;
        }

        ordersBody.innerHTML = rows
          .map(
            (o) => `
              <tr>
                <td>${o.orderId}</td>
                <td>${o.side}</td>
                <td>${o.price}</td>
                <td>${o.originalQty}</td>
                <td>${o.currentQty}</td>
                <td>${o.status}</td>
              </tr>
            `
          )
          .join("");
      };

      renderOrders();

      const makeFakeUuid = () => {
        if (globalThis.crypto && typeof globalThis.crypto.randomUUID === "function") {
          return globalThis.crypto.randomUUID();
        }
        // Simple fallback UUID-ish generator for older browsers.
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
          const r = Math.floor(Math.random() * 16);
          const v = c === "x" ? r : (r & 0x3) | 0x8;
          return v.toString(16);
        });
      };

      const getOrCreateClientId = () => {
        const key = "orderbook-test-client-id";
        let id = localStorage.getItem(key);
        if (!id) {
          id = makeFakeUuid();
          localStorage.setItem(key, id);
        }
        return id;
      };

      let clientId = getOrCreateClientId();
      clientIdEl.textContent = clientId;

      regenClientIdBtn.addEventListener("click", () => {
        clientId = makeFakeUuid();
        localStorage.setItem("orderbook-test-client-id", clientId);
        clientIdEl.textContent = clientId;
        ordersById = new Map();
        rejectionsEl.hidden = true;
        rejectionsEl.textContent = "";
        renderOrders();
        log("new clientId: " + clientId);
      });

      const setSide = (side) => {
        selectedSide = side;
        buyBtn.classList.toggle("active", side === "buy");
        sellBtn.classList.toggle("active", side === "sell");
        selectedSideLabel.textContent = side;
      };

      buyBtn.addEventListener("click", () => setSide("buy"));
      sellBtn.addEventListener("click", () => setSide("sell"));

      const ws = new WebSocket("ws://localhost:8080");

      ws.onopen = () => {
        log("connected");
      };

      ws.onmessage = (e) => {
        log("server: " + e.data);
        let msg;
        try {
          msg = JSON.parse(e.data);
        } catch {
          return;
        }

        if (msg.type === "order_state_snapshot" && msg.clientId === clientId && Array.isArray(msg.orders)) {
          ordersById = new Map(msg.orders.map((order) => [order.orderId, order]));
          renderOrders();
          return;
        }

        if (msg.type === "place_rejected") {
          rejectionsEl.hidden = false;
          rejectionsEl.textContent = `Rejected: ${msg.reason ?? "unknown reason"}`;
        }
      };
      ws.onerror = () => log("error: websocket error");
      ws.onclose = () => log("closed");

      form.addEventListener("submit", (e) => {
        e.preventDefault();

        const payload = {
          clientId: clientId,
          type: "place",
          side: selectedSide,
          price: Number(priceInput.value),
          qty: Number(qtyInput.value),
        };

        if (ws.readyState !== WebSocket.OPEN) {
          log("socket not open; cannot send");
          return;
        }

        ws.send(JSON.stringify(payload));
        log("client: " + JSON.stringify(payload));
      });
    </script>
  </body>
</html>